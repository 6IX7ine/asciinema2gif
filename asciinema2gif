#! /usr/bin/env bash

# Released into the Public Domain by tav <tav@espians.com>

# Halt on error.
set -e

readonly program="$(basename "${0}")"
readonly rundir="$(cd "$(dirname "${0}")" && pwd -P)"

# Show instructions when using wrong arguments
if [[ -z "${1}" ]] || ! [[ "${1}" = 'https://asciinema.org/api/asciicasts/'* ]]; then
  echo "usage: ${program} <asciinema api url (of the form https://asciinema.org/api/asciicasts/XXXX)>"
  exit 1
fi

# Execute this in a subshell, changing to a temporary directory.
(
  readonly tempdir="$(mktemp -d -t asciinema2gif.XXX)"
  echo "Creating and changing to temporary dir: ${tempdir}"
  cd "${tempdir}"

  # rm -rf frames
  # rm -f asciicast.gif

  phantomjs "${rundir}/render.js" "${1}"

  echo '>> Generating GIF ...'
  convert -delay 5 -loop 0 frames/*.png gif:- | gifsicle --colors=256 --delay=6 --optimize=3 > asciicast.gif

  echo ">> Generated: ${PWD}/asciicast.gif"
)
